#!/bin/bash

# Script d'audit Synology optimis√© pour compatibilit√© maximale
# Version rapide sans commandes probl√©matiques

set -e

# Configuration
AUDIT_DIR="/tmp/synology_audit_fast_$(date +%Y%m%d_%H%M%S)"
HOSTNAME=$(hostname)
DATE=$(date '+%Y-%m-%d %H:%M:%S')

# Couleurs
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[$(date +'%H:%M:%S')]${NC} $1"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Initialisation
init_audit() {
    mkdir -p "$AUDIT_DIR"
    echo "=== AUDIT SYNOLOGY RAPIDE ==="
    log "Hostname: $HOSTNAME"
    log "Date: $DATE"
    log "R√©pertoire: $AUDIT_DIR"
    echo ""
}

# 1. Informations syst√®me essentielles
audit_system_fast() {
    local output="$AUDIT_DIR/system_info.txt"
    log "Collecte informations syst√®me..."
    
    {
        echo "=== INFORMATIONS SYST√àME ==="
        echo "Date: $DATE"
        echo "Hostname: $HOSTNAME"
        echo ""
        
        echo "=== VERSION DSM ==="
        if [ -f /etc/VERSION ]; then
            cat /etc/VERSION
        elif [ -f /etc.defaults/VERSION ]; then
            cat /etc.defaults/VERSION
        else
            echo "Version DSM non trouv√©e"
        fi
        echo ""
        
        echo "=== SYST√àME ==="
        echo "Architecture: $(uname -m)"
        echo "Kernel: $(uname -r)"
        echo "Uptime: $(uptime)"
        echo ""
        
        echo "=== M√âMOIRE ==="
        free -h 2>/dev/null || free
        echo ""
        
        echo "=== R√âSEAU ==="
        hostname -I 2>/dev/null || echo "IP non disponible"
        
    } > "$output"
    
    info "‚úÖ Syst√®me: $(basename "$output")"
}

# 2. Stockage - LE PLUS IMPORTANT
audit_storage_fast() {
    local output="$AUDIT_DIR/storage_usage.txt"
    log "Analyse stockage (peut prendre 1-2 minutes)..."
    
    {
        echo "=== UTILISATION STOCKAGE ==="
        echo "Date: $DATE"
        echo ""
        
        echo "=== VOLUMES MONT√âS ==="
        df -h
        echo ""
        
        echo "=== ESPACE VOLUME1 ==="
        if [ -d /volume1 ]; then
            echo "Espace total volume1:"
            df -h /volume1
            echo ""
            
            echo "=== TOP 20 DOSSIERS LES PLUS LOURDS ==="
            echo "Calcul en cours..."
            timeout 120 du -sh /volume1/* 2>/dev/null | sort -hr | head -20 || echo "Timeout ou erreur - calcul partiel"
            echo ""
            
            echo "=== STRUCTURE VOLUME1 ==="
            ls -la /volume1/ 2>/dev/null | head -30
        else
            echo "Volume1 non trouv√©"
        fi
        
    } > "$output"
    
    info "‚úÖ Stockage: $(basename "$output")"
}

# 3. Utilisateurs
audit_users_fast() {
    local output="$AUDIT_DIR/users_config.txt"
    log "Collecte utilisateurs..."
    
    {
        echo "=== UTILISATEURS ET GROUPES ==="
        echo "Date: $DATE"
        echo ""
        
        echo "=== COMPTES UTILISATEURS ==="
        if command -v synouser &> /dev/null; then
            synouser --enum all 2>/dev/null || echo "Erreur synouser"
        else
            echo "Utilisateurs syst√®me (UID >= 1000):"
            awk -F: '$3 >= 1000 || $1 == "admin" {print $1 " (UID:" $3 ", Home:" $6 ")"}' /etc/passwd 2>/dev/null
        fi
        echo ""
        
        echo "=== DOSSIERS HOME ==="
        if [ -d /volume1/homes ]; then
            ls -la /volume1/homes/ 2>/dev/null
        else
            echo "Pas de dossier homes"
        fi
        echo ""
        
        echo "=== SESSIONS ACTUELLES ==="
        who 2>/dev/null || echo "Aucune session"
        
    } > "$output"
    
    info "‚úÖ Utilisateurs: $(basename "$output")"
}

# 4. Partages SMB
audit_shares_fast() {
    local output="$AUDIT_DIR/smb_shares.txt"
    log "Analyse partages SMB..."
    
    {
        echo "=== CONFIGURATION PARTAGES SMB ==="
        echo "Date: $DATE"
        echo ""
        
        if [ -f /etc/samba/smb.conf ]; then
            echo "=== PARTAGES CONFIGUR√âS ==="
            grep "^\[" /etc/samba/smb.conf | grep -v global
            echo ""
            
            echo "=== CONFIGURATION D√âTAILL√âE ==="
            awk '/^\[/{section=$0} /^[[:space:]]*(path|comment|valid users|read only)/{print section ": " $0}' /etc/samba/smb.conf 2>/dev/null
            echo ""
            
            echo "=== WORKGROUP ET SERVEUR ==="
            grep -E "(workgroup|server string)" /etc/samba/smb.conf 2>/dev/null || echo "Configuration standard"
        else
            echo "Fichier smb.conf non trouv√©"
        fi
        
    } > "$output"
    
    info "‚úÖ Partages: $(basename "$output")"
}

# 5. Services r√©seau
audit_services_fast() {
    local output="$AUDIT_DIR/network_services.txt"
    log "Analyse services r√©seau..."
    
    {
        echo "=== SERVICES R√âSEAU ==="
        echo "Date: $DATE"
        echo ""
        
        echo "=== PORTS OUVERTS ==="
        if command -v netstat &> /dev/null; then
            netstat -tlpn 2>/dev/null | grep LISTEN | while read line; do
                port=$(echo "$line" | awk '{print $4}' | awk -F: '{print $NF}')
                process=$(echo "$line" | awk '{print $7}' | cut -d/ -f2 2>/dev/null || echo "unknown")
                echo "Port $port: $process"
            done
        else
            echo "netstat non disponible"
        fi
        echo ""
        
        echo "=== SERVICES PRINCIPAUX ==="
        echo "SSH: $(pgrep sshd > /dev/null && echo "Actif" || echo "Inactif")"
        echo "SMB: $(pgrep smbd > /dev/null && echo "Actif" || echo "Inactif")"
        echo "NFS: $(pgrep nfsd > /dev/null && echo "Actif" || echo "Inactif")"
        
    } > "$output"
    
    info "‚úÖ Services: $(basename "$output")"
}

# 6. Applications install√©es
audit_apps_fast() {
    local output="$AUDIT_DIR/applications.txt"
    log "Inventaire applications..."
    
    {
        echo "=== APPLICATIONS INSTALL√âES ==="
        echo "Date: $DATE"
        echo ""
        
        echo "=== PACKAGES SYNOLOGY ==="
        if [ -d /var/packages ]; then
            echo "Packages d√©tect√©s:"
            ls -1 /var/packages/ 2>/dev/null
            echo ""
            
            echo "D√©tails des packages principaux:"
            for pkg in /var/packages/*/INFO; do
                if [ -f "$pkg" ]; then
                    pkg_name=$(dirname "$pkg" | xargs basename)
                    version=$(grep "version=" "$pkg" 2>/dev/null | cut -d= -f2 | tr -d '"')
                    echo "$pkg_name: $version"
                fi
            done | head -20
        else
            echo "Aucun package trouv√©"
        fi
        echo ""
        
        echo "=== DOCKER ==="
        if command -v docker &> /dev/null; then
            echo "Docker install√©:"
            docker ps -a 2>/dev/null | wc -l || echo "Erreur Docker"
        else
            echo "Docker non install√©"
        fi
        
    } > "$output"
    
    info "‚úÖ Applications: $(basename "$output")"
}

# G√©n√©ration du rapport de synth√®se
generate_report_fast() {
    local report="$AUDIT_DIR/RAPPORT_MIGRATION.md"
    log "G√©n√©ration rapport de synth√®se..."
    
    {
        echo "# Audit Synology - Rapport de migration"
        echo ""
        echo "**Date:** $DATE"
        echo "**Syst√®me:** $HOSTNAME"
        echo ""
        
        echo "## üíæ Utilisation stockage"
        if [ -f "$AUDIT_DIR/storage_usage.txt" ]; then
            echo ""
            echo "### Espace volume1"
            grep -A3 "df -h /volume1" "$AUDIT_DIR/storage_usage.txt" | tail -1 || echo "Non disponible"
            echo ""
            
            echo "### Top 10 dossiers les plus lourds"
            echo '```'
            grep -A15 "TOP 20 DOSSIERS" "$AUDIT_DIR/storage_usage.txt" | head -15 || echo "Non calcul√©"
            echo '```'
        fi
        echo ""
        
        echo "## üìÅ Partages SMB √† recr√©er"
        if [ -f "$AUDIT_DIR/smb_shares.txt" ]; then
            echo ""
            echo "### Partages configur√©s"
            echo '```'
            grep "^\[" "$AUDIT_DIR/smb_shares.txt" | grep -v "===" || echo "Aucun partage trouv√©"
            echo '```'
        fi
        echo ""
        
        echo "## üë• Utilisateurs √† reconfigurer"
        if [ -f "$AUDIT_DIR/users_config.txt" ]; then
            echo ""
            echo "### Comptes utilisateurs"
            echo '```'
            grep -A10 "COMPTES UTILISATEURS" "$AUDIT_DIR/users_config.txt" | tail -10 || echo "Non disponible"
            echo '```'
        fi
        echo ""
        
        echo "## üåê Services r√©seau actifs"
        if [ -f "$AUDIT_DIR/network_services.txt" ]; then
            echo ""
            echo "### Services principaux"
            echo '```'
            grep -A5 "SERVICES PRINCIPAUX" "$AUDIT_DIR/network_services.txt" | tail -5 || echo "Non disponible"
            echo '```'
        fi
        echo ""
        
        echo "## üì¶ Applications install√©es"
        if [ -f "$AUDIT_DIR/applications.txt" ]; then
            echo ""
            echo "### Packages Synology"
            echo '```'
            grep -A10 "Packages d√©tect√©s" "$AUDIT_DIR/applications.txt" | tail -10 || echo "Non disponible"
            echo '```'
        fi
        echo ""
        
        echo "## ‚úÖ Checklist migration"
        echo ""
        echo "- [ ] **Espace disque DXP4800+** : V√©rifier capacit√© suffisante"
        echo "- [ ] **Recr√©er partages SMB** dans interface UGOS"
        echo "- [ ] **Configurer utilisateurs** dans UGOS"
        echo "- [ ] **Activer services** (SSH, SMB, etc.)"
        echo "- [ ] **R√©installer applications** n√©cessaires"
        echo "- [ ] **Tester connectivit√©** apr√®s migration"
        echo ""
        
        echo "---"
        echo "**G√©n√©r√© par:** Audit Synology Rapide"
        echo "**Fichiers:** $(ls -1 "$AUDIT_DIR"/*.txt | wc -l) fichiers de donn√©es"
        
    } > "$report"
    
    info "‚úÖ Rapport: $(basename "$report")"
}

# Fonction principale
main() {
    init_audit
    
    audit_system_fast
    audit_storage_fast
    audit_users_fast
    audit_shares_fast
    audit_services_fast
    audit_apps_fast
    generate_report_fast
    
    # Archive
    if command -v tar &> /dev/null; then
        local archive="/tmp/synology_audit_fast_$(date +%Y%m%d_%H%M%S).tar.gz"
        tar -czf "$archive" -C "$(dirname "$AUDIT_DIR")" "$(basename "$AUDIT_DIR")" 2>/dev/null
        log "üì¶ Archive cr√©√©e: $archive"
    fi
    
    echo ""
    echo "=== AUDIT RAPIDE TERMIN√â ==="
    echo ""
    echo "üìÅ R√©pertoire: $AUDIT_DIR"
    echo "üìÑ Rapport principal: $AUDIT_DIR/RAPPORT_MIGRATION.md"
    echo ""
    echo "üí° Sauvegardez ces fichiers avant migration !"
}

# Lancement
main "$@"
